<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Reports</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <style>
        body {
            background-image: url('./images/bg.jpg');
            background-size: cover;
            background-repeat: no-repeat;
            background-attachment: fixed;
            font-family: 'Segoe UI', sans-serif;
            padding: 0;
            margin: 0;
        }

        .card {
            margin-bottom: 20px;
        }

        .tab-content {
            padding-top: 20px;
        }

        .report-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .print-btn {
            float: right;
        }

        .filter-select {
            max-width: 200px;
        }
    </style>
</head>

<body>

    <div class="container">
        <h2 class="mb-4 text-center">Business Reports</h2>

        <ul class="nav nav-tabs" id="reportTabs" role="tablist">
            <li class="nav-item">
                <a class="nav-link active" id="sales-tab" data-toggle="tab" href="#sales" role="tab">Sales Report</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="inventory-tab" data-toggle="tab" href="#inventory" role="tab">Inventory
                    Report</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="credit-tab" data-toggle="tab" href="#credit" role="tab">Credit Report</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="staff-tab" data-toggle="tab" href="#staff" role="tab">Staff Activity Report</a>
            </li>
        </ul>

        <div class="tab-content" id="reportTabsContent">

            <!-- Sales Report -->
            <div class="tab-pane fade show active" id="sales" role="tabpanel">
                <div class="report-header">
                    <h5>Sales Report</h5>
                    <div>
                        <select class="form-control filter-select" id="salesFilter">
                            <option value="daily">Daily</option>
                            <option value="weekly">Weekly</option>
                            <option value="monthly">Monthly</option>
                            <option value="yearly">Yearly</option>
                        </select>
                        <div class="d-flex">
                            <button class="btn btn-secondary mr-2" onclick="printSection('sales')">Print</button>
                            <button class="btn btn-success" onclick="downloadPDF('sales')">Download PDF</button>
                        </div>

                    </div>
                </div>
                <div id="salesContent" class="card p-3">
                    <p>Total Sales: <span id="salesTotal">UGX 0.00</span></p>
                    <p>Total Cost: <span id="salesCost">UGX 0.00</span></p>
                    <p>Total Expenses: <span id="totalExpenses">UGX 0.00</span></p>
                    <p>Total Profit: <span id="salesProfit">UGX 0.00</span></p>
                </div>

            </div>

            <!-- Inventory Report -->
            <div class="tab-pane fade" id="inventory" role="tabpanel">
                <div class="report-header">
                    <h5>Inventory Report</h5>
                    <div class="d-flex">
                        <button class="btn btn-secondary mr-2" onclick="printSection('inventory')">Print</button>
                        <button class="btn btn-success" onclick="downloadPDF('inventory')">Download PDF</button>
                    </div>
                </div>
                <!-- <div id="inventoryContent" class="card p-3">
                    <ul>
                        <li><strong>Fast Moving Products:</strong> Product A, Product B</li>
                        <li><strong>Slow Moving Products:</strong> Product C</li>
                        <li><strong>Out of Stock:</strong> Product D</li>
                        <li><strong>Other Notes:</strong> Summary info here...</li>
                    </ul>
                </div> -->
                <div id="inventoryContent" class="card p-3">
                    Loading...
                </div>
            </div>

            <!-- Credit Report -->
            <div class="tab-pane fade" id="credit" role="tabpanel">
                <div class="report-header">
                    <h5>Credit Report</h5>
                    <div class="d-flex">
                        <button class="btn btn-secondary mr-2" onclick="printSection('credit')">Print</button>
                        <button class="btn btn-success" onclick="downloadPDF('credit')">Download PDF</button>
                    </div>
                </div>
                <!-- <div id="creditContent" class="card p-3">
                    <ul>
                        <li>John Doe – UGX 50,000 – <em>Follow up 5/July</em></li>
                        <li>Mary Jane – UGX 30,000 – <em>Follow up 6/July</em></li>
                        <li>Total Owed: UGX 80,000</li>
                    </ul>
                </div> -->
                <div id="creditContent" class="card p-3">
                    Loading...
                </div>
            </div>

            <!-- Staff Activity Report -->
            <div class="tab-pane fade" id="staff" role="tabpanel">
                <div class="report-header">
                    <h5>Staff Activity Report</h5>
                    <div class="d-flex">
                        <button class="btn btn-secondary mr-2" onclick="printSection('staff')">Print</button>
                        <button class="btn btn-success" onclick="downloadPDF('staff')">Download PDF</button>
                    </div>
                </div>
                <!-- <div id="staffContent" class="card p-3">
                    <ul>
                        <li>Cashier A: 10 Sales - UGX 200,000</li>
                        <li>Cashier B: 6 Sales - UGX 130,000</li>
                        <li>Errors Detected: 2</li>
                    </ul>
                </div> -->
                <div id="staffContent" class="card p-3">
                    Loading...
                </div>
            </div>

        </div>
    </div>


    <script>
        function fetchSalesReport() {
            const filter = document.getElementById("salesFilter").value;
            const apiUrl = `http://127.0.0.1:5000/getSalesReport?filter=${filter}`;

            fetch(apiUrl)
                .then(response => response.json())
                .then(data => {
                    document.getElementById("salesTotal").innerText = `UGX ${parseFloat(data.total_sales || 0).toLocaleString()}`;
                    document.getElementById("salesCost").innerText = `UGX ${parseFloat(data.total_cost || 0).toLocaleString()}`;
                    document.getElementById("totalExpenses").innerText = `UGX ${parseFloat(data.total_expenses || 0).toLocaleString()}`;
                    document.getElementById("salesProfit").innerText = `UGX ${parseFloat(data.total_profit || 0).toLocaleString()}`;
                })
                .catch(error => {
                    console.error("Error fetching sales report:", error);
                    alert("Failed to load sales report.");
                });
        }

        document.getElementById("salesFilter").addEventListener("change", fetchSalesReport);
        window.onload = fetchSalesReport;
        // window.onload = function () {
        //     fetchSalesReport();
        //     fetchInventoryReport();
        //     fetchCreditReport();
        //     fetchStaffReport();
        // };

        // function fetchInventoryReport() {
        //     fetch("http://127.0.0.1:5000/getInventoryReport")
        //         .then(res => res.json())
        //         .then(data => {
        //             document.getElementById("inventoryContent").innerHTML = `
        //         <ul>
        //             <li><strong>Fast Moving Products:</strong> ${data.fast_moving.join(', ')}</li>
        //             <li><strong>Slow Moving Products:</strong> ${data.slow_moving.join(', ')}</li>
        //             <li><strong>Out of Stock:</strong> ${data.out_of_stock.join(', ')}</li>
        //         </ul>`;
        //         });
        // }

        // function fetchCreditReport() {
        //     fetch("http://127.0.0.1:5000/getCreditReport")
        //         .then(res => res.json())
        //         .then(data => {
        //             const listItems = data.credits.map(c =>
        //                 `<li>${c.customer_name} – UGX ${c.amount_owed} – <em>Follow up ${c.follow_up_date}</em></li>`
        //             ).join("");
        //             document.getElementById("creditContent").innerHTML = `
        //         <ul>${listItems}<li>Total Owed: UGX ${data.total_owed}</li></ul>`;
        //         });
        // }

        // function fetchStaffReport() {
        //     fetch("http://127.0.0.1:5000/getStaffReport")
        //         .then(res => res.json())
        //         .then(data => {
        //             const list = data.staff.map(s =>
        //                 `<li>${s.cashier_name}: ${s.sales_count} Sales – UGX ${s.total_sales}</li>`
        //             ).join("");
        //             document.getElementById("staffContent").innerHTML = `
        //         <ul>${list}<li>Errors Detected: ${data.errors}</li></ul>`;
        //         });
        // }

    </script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script>
        function printSection(id) {
            const content = document.getElementById(id + 'Content').innerHTML;
            const win = window.open('', '', 'width=900,height=700');

            const html = `
        <!DOCTYPE html>
        <html>
        <head>
            <title>Print Report</title>
            <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
            <style>
                body { font-family: 'Segoe UI', sans-serif; padding: 20px; }
            </style>
        </head>
        <body>
            ${content}
            <script>
                window.onload = function() {
                    window.print();
                    setTimeout(function() { window.close(); }, 100);
                };
            <\/script>
        </body>
        </html>
        `;

            win.document.write(html);
            win.document.close();
        }

        function downloadPDF(id) {
            console.log("Starting PDF download for section:", id);

            const element = document.getElementById(id + 'Content');
            if (!element) {
                console.error("Element not found:", id + 'Content');
                alert("Content not found for PDF generation.");
                return;
            }

            console.log("Element found. Preparing options...");

            const opt = {
                margin: 0.5,
                filename: `${id}_report.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2 },
                jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
            };

            console.log("Options set. Generating PDF...");

            html2pdf().from(element).set(opt).save()
                .then(() => {
                    console.log("PDF successfully downloaded.");
                })
                .catch((error) => {
                    console.error("PDF generation failed:", error);
                    alert("An error occurred while downloading the PDF.");
                });
        }
    </script>


    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
</body>

</html>