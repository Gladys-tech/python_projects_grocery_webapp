<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Reports</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <style>
        body {
            background-image: url('./images/bg.jpg');
            background-size: cover;
            background-repeat: no-repeat;
            background-attachment: fixed;
            font-family: 'Segoe UI', sans-serif;
            padding: 0;
            margin: 0;
        }

        .card {
            margin-bottom: 20px;
        }

        .tab-content {
            padding-top: 20px;
        }

        .report-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .report-header h5 {
            margin: 0;
            padding: 10px;
            font-weight: bold;
            color: #2196f3;
            background-color: #fff;
        }

        .filter-select {
            max-width: 200px;
        }

        .custom-back-btn {
            background-color: #2196f3;
            /* Blue background */
            color: black;
            /* Black arrow/text */
            border: none;
            /* Remove default border */
            font-weight: bold;
            /* Make arrow bold */
        }

        .custom-back-btn:hover {
            background-color: #1976d2;
            /* Darker blue on hover */
            color: black;
            /* Keep text black */
        }
    </style>
</head>

<body>

    <div class="container">
        <h2 class="mb-4 text-center">Business Reports</h2>
        <button class="btn custom-back-btn mb-3 mt-3 ml-3" onclick="goBack()">
            &#8592; Back
        </button>
        <ul class="nav nav-tabs" id="reportTabs" role="tablist">
            <li class="nav-item">
                <a class="nav-link active" id="sales-tab" data-toggle="tab" href="#sales" role="tab">Sales Report</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="inventory-tab" data-toggle="tab" href="#inventory" role="tab">Inventory
                    Report</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="staff-tab" data-toggle="tab" href="#staff" role="tab">Staff Activity Report</a>
            </li>
        </ul>

        <div class="tab-content" id="reportTabsContent">

            <!-- Sales Report -->
            <div class="tab-pane fade show active" id="sales" role="tabpanel">
                <div class="report-header">
                    <h5>Sales Report</h5>
                    <div class="d-flex">
                        <select class="form-control filter-select" id="salesFilter">
                            <option value="daily">Daily</option>
                            <option value="weekly">Weekly</option>
                            <option value="monthly">Monthly</option>
                            <option value="yearly">Yearly</option>
                        </select>
                        <div class="dropdown ml-3">
                            <button class="btn btn-success dropdown-toggle" type="button" id="downloadMenu"
                                data-toggle="dropdown">
                                Download
                            </button>
                            <div class="dropdown-menu">
                                <a class="dropdown-item" href="#" onclick="downloadReport('sales','pdf')">PDF</a>
                                <a class="dropdown-item" href="#" onclick="downloadReport('sales','csv')">CSV</a>
                                <a class="dropdown-item" href="#" onclick="downloadReport('sales','excel')">Excel</a>
                            </div>
                        </div>

                    </div>
                </div>
                <div id="salesContent" class="card p-3">
                    <p>Total Sales: <span id="salesTotal">UGX 0.00</span></p>
                    <p>Total Cost: <span id="salesCost">UGX 0.00</span></p>
                    <p>Total Expenses: <span id="totalExpenses">UGX 0.00</span></p>
                    <p>Total Profit: <span id="salesProfit">UGX 0.00</span></p>
                </div>

            </div>

            <!-- Inventory Report -->
            <div class="tab-pane fade" id="inventory" role="tabpanel">
                <div class="report-header">
                    <h5>Inventory Report</h5>
                    <div class="dropdown ml-3">
                        <button class="btn btn-success dropdown-toggle" type="button" id="downloadMenu"
                            data-toggle="dropdown">
                            Download
                        </button>
                        <div class="dropdown-menu">
                            <a class="dropdown-item" href="#" onclick="downloadReport('inventory','pdf')">PDF</a>
                            <a class="dropdown-item" href="#" onclick="downloadReport('inventory','csv')">CSV</a>
                            <a class="dropdown-item" href="#" onclick="downloadReport('inventory','excel')">Excel</a>
                        </div>
                    </div>
                </div>
                <div id="inventoryContent" class="card p-3">
                    Loading...
                </div>
            </div>

            <!-- Staff Activity Report -->
            <div class="tab-pane fade" id="staff" role="tabpanel">
                <div class="report-header">
                    <h5>Staff Activity Report</h5>
                    <div class="d-flex">
                        <button class="btn btn-success ml-3" onclick="downloadPDF('staff')">Download</button>
                    </div>
                </div>
                <!-- <div id="staffContent" class="card p-3">
                    <ul>
                        <li>Cashier A: 10 Sales - UGX 200,000</li>
                        <li>Cashier B: 6 Sales - UGX 130,000</li>
                        <li>Errors Detected: 2</li>
                    </ul>
                </div> -->
                <div id="staffContent" class="card p-3">
                    Loading...
                </div>
            </div>

        </div>
    </div>
    <!-- jQuery (required for Bootstrap 4) -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>

    <!-- Popper.js (required for dropdowns, tooltips, etc.) -->
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>

    <!-- Bootstrap 4 JS -->
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

    <script>
        function fetchSalesReport() {
            const filter = document.getElementById("salesFilter").value;
            const apiUrl = `http://127.0.0.1:5000/getSalesReport?filter=${filter}`;

            fetch(apiUrl)
                .then(response => response.json())
                .then(data => {
                    document.getElementById("salesTotal").innerText = `UGX ${parseFloat(data.total_sales || 0).toLocaleString()}`;
                    document.getElementById("salesCost").innerText = `UGX ${parseFloat(data.total_cost || 0).toLocaleString()}`;
                    document.getElementById("totalExpenses").innerText = `UGX ${parseFloat(data.total_expenses || 0).toLocaleString()}`;
                    document.getElementById("salesProfit").innerText = `UGX ${parseFloat(data.total_profit || 0).toLocaleString()}`;
                })
                .catch(error => {
                    console.error("Error fetching sales report:", error);
                    alert("Failed to load sales report.");
                });
        }

        document.getElementById("salesFilter").addEventListener("change", fetchSalesReport);
        window.onload = fetchSalesReport;


        // API URL for fetching product list
        const productListApiUrl = 'http://127.0.0.1:5000/getProducts';
        function fetchInventoryReport() {
            fetch(productListApiUrl)
                .then(res => res.json())
                .then(data => {
                    console.log("Inventory API data:", data); // <-- log the data to console

                    if (!data || data.length === 0) {
                        document.getElementById("inventoryContent").innerHTML = "<p>No products found.</p>";
                        return;
                    }

                    // Categorize products dynamically
                    const outOfStock = data.filter(p => p.quantity === 0).map(p => p.name);
                    const slowMoving = data.filter(p => p.quantity > 0 && p.quantity <= 20).map(p => p.name);
                    const fastMoving = data.filter(p => p.quantity > 20).map(p => p.name);


                    document.getElementById("inventoryContent").innerHTML = `
                <ul>
                    <li><strong>Fast Moving Products:</strong> ${fastMoving.join(', ') || 'None'}</li>
                    <li><strong>Slow Moving Products:</strong> ${slowMoving.join(', ') || 'None'}</li>
                    <li><strong>Out of Stock Products:</strong> ${outOfStock.join(', ') || 'None'}</li>
                    <li><strong>Total Number Of Products:</strong> ${data.length}</li>
                </ul>`;
                })
                .catch(error => {
                    console.error("Error fetching inventory report:", error);
                    document.getElementById("inventoryContent").innerHTML = "<p>Failed to load inventory report.</p>";
                });
        }
        // Fetch inventory report when the tab is shown
        $('#inventory-tab').on('shown.bs.tab', function () {
            fetchInventoryReport();
        });

        function goBack() {
            window.location.href = "index.html";
        }
        // function fetchStaffReport() {
        //     fetch("http://127.0.0.1:5000/getStaffReport")
        //         .then(res => res.json())
        //         .then(data => {
        //             const list = data.staff.map(s =>
        //                 `<li>${s.cashier_name}: ${s.sales_count} Sales â€“ UGX ${s.total_sales}</li>`
        //             ).join("");
        //             document.getElementById("staffContent").innerHTML = `
        //         <ul>${list}<li>Errors Detected: ${data.errors}</li></ul>`;
        //         });
        // }

    </script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script>
        function downloadReport(id, type) {
            const element = document.getElementById(id + 'Content');
            if (!element) {
                alert("Content not found.");
                return;
            }

            // Get the heading text dynamically
            const headingElement = document.querySelector(`#${id} .report-header h5`);
            const headingText = headingElement ? headingElement.innerText : '';

            if (type === 'pdf') {
                // Clone the content and prepend heading
                const cloned = element.cloneNode(true);
                const heading = document.createElement('h3');
                heading.innerText = headingText;
                heading.style.textAlign = 'center';
                heading.style.marginBottom = '20px';
                cloned.prepend(heading);

                const opt = {
                    margin: 0.5,
                    filename: `${id}_report.pdf`,
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: { scale: 2 },
                    jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
                };
                html2pdf().from(cloned).set(opt).save();

            } else if (type === 'csv' || type === 'excel') {
                // Grab plain text (one line per <p>)
                const rows = [`${headingText}`]; // add heading as first row
                [...element.querySelectorAll("p")].forEach(p => {
                    rows.push(p.innerText.replace(/:/, ","));
                });

                let csvContent = rows.join("\n");
                let blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
                let link = document.createElement("a");
                link.href = URL.createObjectURL(blob);
                link.download = `${id}_report.${type === 'excel' ? 'xls' : 'csv'}`;
                link.click();
            }
        }
    </script>

</body>

</html>